---
# This is a job file for kubernetes to run the fs-performance tests
#
# Usage:
# - Modify the PVC to obtain the type of storage you want to test.
#   This includes adjusting the accessModes and storageClass.
# - Apply this file: kubectl apply -f fs-performance.yml
# - When the job is done, read the pod log for the results.
# - Clean up: kubctl delete -f fs-performance.yml

kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: fs-perf-target-ior
  namespace: cnsa-benchmark
spec:
  # To test a particular type of storage, set the name of the StorageClass here.
  storageClassName: ibm-spectrum-scale-fileset
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 4000Gi

---

# This doesn't actually work when launching. You need to terminal inside the
# launcher pod and manually run the command.
# mpirun -np 96 /usr/local/bin/ior -a POSIX -b 24G -t 16M -o /target/test_ior/test_ior -w -r -C -F -i 3
apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: ior-benchmarks-wrk6
  namespace: cnsa-benchmark
spec:
  sshAuthMountPath: /home/mpiuser/.ssh
  mpiImplementation: MPICH
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          containers:
          - command:
            - mpirun
            - -np
            - "32"
            - /usr/local/bin/ior
            - -a
            - POSIX
            - -b
            - 10G
            - -t
            - 16M
            - -o
            - /target/test_ior/test
            - -r
            - -w
            - -r
            - -C
            - -F
            - -i
            - "1"
            image: ghcr.io/knikolla/ior-container:sha-f5deac3
            name: ior-job
            volumeMounts:
              - name: target
                mountPath: /target
            securityContext:
              runAsUser: 1001110000
              capabilities:
                add:
                  - NET_BIND_SERVICE
          nodeName: wrk-6
          restartPolicy: Never
          volumes:
            - name: target
              persistentVolumeClaim:
                claimName: fs-perf-target-ior
    Worker:
      replicas: 96
      template:
          spec:
            containers:
            - image: ghcr.io/knikolla/ior-container:sha-f5deac3
              name: ior-job
              command:
                - /usr/sbin/sshd
              args:
                - -De
                - -f
                - /home/mpiuser/.sshd_config
              volumeMounts:
                - name: target
                  mountPath: /target
              resources:
                requests:
                  cpu: 2
                  memory: 4G
              readinessProbe:
                tcpSocket:
                  port: 2222
                initialDelaySeconds: 2
              securityContext:
                capabilities:
                  add:
                    - NET_BIND_SERVICE
                runAsUser: 1001110000
            nodeSelector:
              scale.spectrum.ibm.com/designation: quorum
            restartPolicy: Never
            volumes:
              - name: target
                persistentVolumeClaim:
                  claimName: fs-perf-target-ior
